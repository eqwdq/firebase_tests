<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>

        img {
            height: 200px;
            width: 315x;
            border: 2px black solid ;
        }
    </style>
</head>
<body>

    <label >Image Name</label><input type="text" id="imgname"> <label id="extlab"></label> <br> <br>
    <img id="myimg"> <label id="imgprogress"></label> <br> <br>

    <button id="selimg">Select Image</button>
    <button id="upimg">Upload Image</button>
    <button id="downimg">Retrieve Image</button>
    <br>
    <br>
    <!-- <input type="text" id="Namebox" placeholder="Meno produktu">
    <input type="text" id="Rollbox" placeholder="id produktu">
    <input type="text" id="Secbox" placeholder="cena produktu">
    <select id="Genbox">
        <option value="category1">kategoria1</option>
        <option value="category2">kategoria2</option>
        <option value="category3">kategoria3</option>
        <option value="category4">kategoria4</option>
    </select> -->

    <!-- kod nad poslanie dat na backend admin page -->
     <input type="text" placeholder="meno " id="inputName"> <br> <br>
    <input type="text" placeholder="popis" id="inputDescription"> <br> <br>
    <input type="text" placeholder="cena " id="inputPrice"> <br> <br>
    <input type="text" placeholder="hodnotenie " id="inputRating"> <br> <br>
    <button id="inputSubmit">Odoslat</button>

    <!-- <br>
    <br>
    <button id="Insbtn">Insert</button>
    <button id="Selbtn">Select</button>
    <button id="Updbtn">Update</button>
    <button id="Delbtn">Delete</button>
    <br>
    <br> -->


    <!-- new design -->

    <!-- <img id="myimg"> <label id="imgprogress"></label> -->
    <!-- <div class="col-4">
        <div class="card shadow-sm">
            <img id="myimg">
            <div class="btn-group" role="group">
                <button id="selimg" class="btn btn-dark btn-sm">Select Image</button>
                <button id="upimg" class="btn btn-dark btn-sm">Upload Image</button>
            </div>
            <label >Image Name</label><input type="text" id="imgname"> <label id="extlab"></label>
            <div class="card-body">
                <textarea name="NameBox" id="Namebox" cols="35" rows="5" placeholder="Meno produktu"></textarea>
                <div class="d-flex justify-content-between align-items-center">

                <button type="button" class="btn btn-sm btn-outline-secondary">View</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">cena</button>

                </div>
            </div>
        </div>
      </div> -->
    <!-- end of new design -->

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-analytics.js";
        import { getDatabase, ref, get, set, child, update, remove } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-storage.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc  } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-firestore.js";

        // TODOs: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCI5SdwdXMQeu3y7AQPZnkcZH_GmIcSgKw",
            authDomain: "login-9a8b6.firebaseapp.com",
            databaseURL: "https://login-9a8b6-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "login-9a8b6",
            storageBucket: "login-9a8b6.appspot.com",
            messagingSenderId: "663312681266",
            appId: "1:663312681266:web:aaff10c5e0a58994ceaf2b",
            measurementId: "G-XTC30ZEDBX"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase();
        const clouddb = getFirestore();

/*----------------------------Javascript--------------------------------------*/

        // var namebox = document.getElementById("Namebox");
        // var rollbox = document.getElementById("Rollbox");
        // var secbox = document.getElementById("Secbox");
        // var genbox = document.getElementById("Genbox");

        // var insbtn = document.getElementById("Insbtn");
        // var selbtn = document.getElementById("Selbtn");
        // var updbtn = document.getElementById("Updbtn");
        // var rembtn = document.getElementById("Delbtn");

        // function insertData(){
        //     set(ref(db, "students/"+rollbox.value), {
        //         Nameofstudent: namebox.value,
        //         rollNo: rollbox.value,
        //         Section: secbox.value,
        //         category: genbox.value,
        //     })
        //     .then(() => {
        //         alert("success");
        //     })
        //     .catch((error)=> {
        //         alert("unsuccesful" + error)
        //     })
        // }

        // function selectData() {
        //     const dbref = ref(db,);

        //     get(child(dbref, "students/"+rollbox.value)).then((snapshot)=> {
        //         if(snapshot.exists()){
        //             namebox.value = snapshot.val().Nameofstudent;
        //             secbox.value = snapshot.val().Section;
        //             genbox.value = snapshot.val().category;
        //         }
        //         else{
        //             alert("no data found");
        //         }
        //     })
        //     .catch((error) => {
        //         alert("no data found"+error);
        //     })
        // }

        // function updateData(){
        //     update(ref(db, "students/"+rollbox.value), {
        //         Nameofstudent: namebox.value,
        //         Section: secbox.value,
        //         category: genbox.value,
        //     })
        //     .then(() => {
        //         alert("update success");
        //     })
        //     .catch((error)=> {
        //         alert("update unsuccesful" + error)
        //     })
        // }

        // function removeData(){
        //     remove(ref(db, "students/"+rollbox.value))
        //     .then(() => {
        //         alert("remove success");
        //     })
        //     .catch((error)=> {
        //         alert("remove unsuccesful" + error)
        //     })
        // }

        // insbtn.addEventListener('click', insertData);
        // selbtn.addEventListener('click', selectData);
        // updbtn.addEventListener('click', updateData);
        // rembtn.addEventListener('click', removeData);


/*------------------------------------Image upload----------------------------------------*/
        var files = [];
        var reader = new FileReader();

        var imgname = document.getElementById("imgname");
        var extlab = document.getElementById("extlab");
        var myimg = document.getElementById("myimg");
        var proglab = document.getElementById("imgprogress");
        var selimg = document.getElementById("selimg");
        var upimg = document.getElementById("upimg");
        var downimg = document.getElementById("downimg");

        var input = document.createElement('input');
        input.type = 'file';

        input.onchange = e => {
            files = e.target.files; // file selected by user

            var extention  = getFileExt(files[0]);
            var name  = getFileName(files[0]);

            imgname.value = name;
            extlab.innerHTML = extention;

            reader.readAsDataURL(files[0]);
        }

        reader.onload = function() {
            myimg.src = reader.result; /* reader will read the file as
                                        url and the url will be parsed into src */
        }

        selimg.onclick = function() {
            input.click();
        }

        function getFileExt(file) {
            var temp = file.name.split('.');
            var ext = temp.slice((temp.length-1),(temp.length));
            return '.' + ext[0];
        }
        function getFileName(file) {
            var temp = file.name.split('.');
            var fname = temp.slice(0,-1).join('.');
            return fname;
        }



        var docRef;
        async function uploadProcess() {
            console.log("uploadPRocess");
            var imgToUpload = files[0];

            var imgName = imgname.value + extlab.innerHTML;

            const metaData = {
                contentType: imgToUpload.type
            }

            const storage = getStorage();
            const storageRef = sRef(storage, "Images/" + imgName);
            const uploadTask = uploadBytesResumable(storageRef, imgToUpload, metaData);

            uploadTask.on('state-changed', (snapshot)=>{
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) *100;
                proglab.innerHTML = "upload " + progress + "%";
            },

            (error) => {
                alert("error image not uploaded");
            },
            ()=> {
                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL, docRef) => {
                    console.log(docRef);
                    saveUrlToFirebase(downloadURL, docRef);
                });
            }
            );

        }

        // async function saveUrlToFirebase(url) {
        //     var name = imgname.value;
        //     var ext = extlab.innerHTML;

        //     var ref = doc(clouddb, "ImageLinks/"+name);

        //     await setDoc(ref,{
        //         ImageName: (name+ext),
        //         ImageURL: url
        //     })
        // }

        async function getImageFromFirestore(){
            var name = imgname.value;

            var ref = doc(clouddb, "ImageLinks/" + name);
            const docSnap = await getDoc(ref);

            if(docSnap.exists()){
                myimg.src = docSnap.data().ImageURL;
            }
        }

        downimg.onclick = getImageFromFirestore;
        upimg.onclick = uploadProcess;


        var inputName = document.getElementById("inputName");
        var inputDescription = document.getElementById("inputDescription");
        var inputPrice = document.getElementById("inputPrice");
        var inputRating = document.getElementById("inputRating");
        var submit = document.getElementById("inputSubmit");


        async function sendToFirestore() {
            console.log("sendToFirestore");
            docRef = await addDoc(collection(clouddb, "metadata"), {
            name: inputName.value,
            desription: inputDescription.value,
            price: inputPrice.value,
            rating: inputRating.value,
            })
        }

        async function saveUrlToFirebase(url,docRef) {

            console.log(docRef);
            var ref = doc(clouddb, "metadata" , docRef.id);
            await updateDoc(ref,{
                ImageURL: url
            })
        }

        submit.addEventListener('click', sendToFirestore);
        submit.onclick = uploadProcess;



    </script>
</body>
</html>